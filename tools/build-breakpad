#!/usr/bin/env python

import os
import sys
import subprocess

import pkgutils
from optparse import OptionParser

build_dir = os.path.abspath(os.path.join(os.path.dirname(__file__), '..', 'out', 'Debug'))


def main():
    usage = "usage: %prog [destination path]"
    parser = OptionParser(usage=usage)
    (options, args) = parser.parse_args()

    if len(args) != 1:
        parser.print_usage()
        sys.exit(1)

    dest = args[0]

    symbol_file = open("%s/%s/monitoring-agent.sym" % (dest, pkgutils.pkg_dir()), 'wb')

    p = subprocess.Popen(["%s/dump_syms" % build_dir, "monitoring-agent"],
        cwd=build_dir, stdout=symbol_file)

    retcode = p.wait()
    symbol_file.close()

    if retcode != 0:
        raise OSError('Failed to run dump_syms: %s' % p.stderr.read())

    print('all done')


if __name__ == "__main__":
    main()
